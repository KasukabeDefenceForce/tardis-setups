name: Multi-Version Simulation
on:
  workflow_dispatch:

env:
  PYTEST_FLAGS: --tardis-regression-data=tardis-setups/tardis-regression-data
defaults:
  run:
    shell: bash -l {0}

jobs:
  simulation:
    strategy:
      matrix:
        tardis-version: ['release-2024.12.22', 'release-2024.07.07']
      fail-fast: false

    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone Tardis
        uses: actions/checkout@v4
        with:
          repository: tardis-sn/tardis
          token: ${{ secrets.TARDIS_TOKEN }}
          ref: ${{ matrix.tardis-version }}

      - name: Generate Cache Key
        id: cache-environment-key
        run: |
          file_hash=$(cat conda-linux-64.lock | shasum -a 256 | cut -d' ' -f1)
          echo "file_hash=$file_hash" >> "${GITHUB_OUTPUT}"
        shell: bash

      - uses: mamba-org/setup-micromamba@v1
        with:
          environment-file: conda-linux-64.lock
          cache-environment-key: ${{ steps.cache-environment-key.outputs.file_hash }}-${{ matrix.tardis-version }}
          cache-downloads-key: ${{ steps.cache-environment-key.outputs.file_hash }}-${{ matrix.tardis-version }}
          environment-name: tardis
          cache-environment: true
          cache-downloads: true

      - name: Install tardis
        run: |
          pip install -e .

      - name: G
        run: |
           mkdir -p tardis-regression-data
           cd tardis
      - name: Setup tmate session      
        uses: mxschmitt/action-tmate@v3
        
      - name: Generate Tests
        run: |
           pytest tardis/spectrum/tests/test_spectrum_solver.py ${{ env.PYTEST_FLAGS }} --generate-reference -m "continuum"

      - uses: actions/upload-artifact@v4
        with:
            name: tardis-outputs-${{ matrix.tardis-version }}
            path: |
               tardis-regression-data/tardis/spectrum/tests/test_spectrum_solver/test_spectrum_solver/TestSpectrumSolver.h5
   
      - name: Show Generated Files
        run: |
          ls -R tardis-regression-data/tardis/spectrum/tests/test_spectrum_solver/test_spectrum_solver/